#!/usr/bin/env bash

if [[ "$1" == "-h" ]]; then
    cat << "EOF"
__     ___      _               _
\ \   / (_)_ __| |_ _   _  __ _| | ___ _ ____   __
 \ \ / /| | '__| __| | | |/ _` | |/ _ \ '_ \ \ / /
  \ V / | | |  | |_| |_| | (_| | |  __/ | | \ V /
   \_/  |_|_|   \__|\__,_|\__,_|_|\___|_| |_|\_/

    _        _   _            _
   / \   ___| |_(_)_   ____ _| |_ ___  _ __
  / _ \ / __| __| \ \ / / _` | __/ _ \| '__|
 / ___ \ (__| |_| |\ V / (_| | || (_) | |
/_/   \_\___|\__|_| \_/ \__,_|\__\___/|_|


    Script searches for nearest venv/bin/activate and sources it.
    Usage:
        . va
        source va
EOF
    exit 0
fi

if ! command -v fd &> /dev/null; then
    cprint "$yellow" "Install fd (fdfind) first"
fi


gray="\033[0;90m"
green="\033[0;32m"
yellow="\033[0;33m"
nocolor="\033[0;0m"


runtime_dir=$(pwd)
venvpath=""
nok=0


cprint () {
    echo "$1$2$nocolor"
}


title=$(cat << "EOF"
                        _             _
__   _____ _ ____   __ | | ___   ___ | | ___   _ _ __
\ \ / / _ \ '_ \ \ / / | |/ _ \ / _ \| |/ / | | | '_ \
 \ V /  __/ | | \ V /  | | (_) | (_) |   <| |_| | |_) |
  \_/ \___|_| |_|\_/   |_|\___/ \___/|_|\_\\\\__,_| .__/
                                                |_|
EOF
)

[[ ! -e "venv/bin/activate" ]] && cprint "$gray" "$title" && echo

git_dir="$(git rev-parse --git-dir 2>/dev/null)"
if ! [[ $? -eq 0 ]]; then
    git_dir="$runtime_dir"
fi

current_path="${git_dir%.git}"
if [[ -z $current_path ]]; then
    current_path="."
fi
while [[ -z $venvpath ]]
do
    if [[ "$current_path" == ~ ]]; then
        cprint "$gray" "Hit home root, abort"
        break
    elif [[ "$current_path" == / ]]; then
        cprint "$gray" "Hit root, abort"
        break
    fi

    venvpath=$(fd -t f -I -H "activate$" "$current_path")
    if [[ -z $venvpath ]]; then
        # cprint "$gray" "fd -t f -I -H \"activate\$\" $current_path -> nah"
        current_path="$current_path/.."
    else
        # cprint "$gray" "fd -t f -I -H \"activate\$\" $(pwd) -> oh"
        if [[ $(echo "$venvpath" | wc -l) -gt 1  ]]; then
            cprint "$yellow" "found multiple possible venvs, wont source anything:"
            cprint "$gray" "$venvpath"
            nok=1
            break
        fi
        venvpath=$(realpath --relative-to="$runtime_dir" "$venvpath")

        if [[ "$venvpath" != "venv/bin/activate" ]]; then
            cprint "$gray" "found ${venvpath/$HOME/~}"
            cprint "$gray" "ok? [Yn] "
            read -r yn
            [[ "$yn" == "n" ]] && return 1
        fi

        . "$venvpath"
        echo -n "${green}OK: ${nocolor}VIRTUAL_ENV=$VIRTUAL_ENV\t"
        pybin="$(which python)"
        pipbin="$(which pip)"
        cprint "$yellow" "{$(python -V)}"
        cprint "$gray" "${pybin#"$runtime_dir"/}"
        cprint "$gray" "${pipbin#"$runtime_dir"/}"
        alias dea='[ -n "$VIRTUAL_ENV" ] && deactivate && unalias dea'
        cprint "$gray" "Run 'dea' to deactivate"
    fi
done

return $nok
